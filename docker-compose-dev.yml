version: '3'
services:  
  # SELENIUM REMOTE WEBDRIVER
  project-selenium:
    container_name: project-selenium
    image: "selenium/standalone-chrome:4.0.0-rc-1-prerelease-20210618"
    logging: { driver: none }
    ports: [4444:4444]
    restart: always
    volumes: [/dev/shm:/dev/shm]
    environment: 
      SE_NODE_MAX_SESSIONS: 4
      SE_NODE_OVERRIDE_MAX_SESSIONS: "true"

  # PROXY
  projec-proxy:
    container_name: todo-proxy
    image: "jwilder/nginx-proxy:latest"
    logging: { driver: none }
    ports: ["${PROXY_SERVICE_PORT}:80"]
    restart: always
    volumes: ["/var/run/docker.sock:/tmp/docker.sock:ro"]

  # REDIS
  project-redis:
    image: redis:latest
    container_name: project-redis
    restart: always    
    ports: ["${REDIS_SERVICE_PORT}:6379"]

  # REDIS COMMANDER
  project-redis-commander:
    container_name: project-redis-commander
    depends_on: [project-redis]
    hostname: redis-commander
    image: rediscommander/redis-commander:latest
    logging: { driver: none }
    ports: ["8081:8081"]
    restart: always
    environment:
      REDIS_HOSTS: local:project-redis:6379

  # TODO COVERAGE SERVER       
  todo-coverage:
    container_name: todo-coverage
    image: 'httpd:latest'
    restart: always
    volumes: ['./todo/htmlcov:/usr/local/apache2/htdocs']
    ports: ['80']
    logging: { driver: none }
    environment:
      - 'VIRTUAL_HOST=todo-test.${DOMAIN}'
  
  # TODO STATIC SERVER       
  todo-static:
    container_name: todo-static
    image: 'httpd:latest'
    logging: { driver: none }
    ports: ['80']
    restart: always
    volumes: ['./todo/static:/usr/local/apache2/htdocs']
    depends_on: [projec-proxy]
    environment:
      - 'VIRTUAL_HOST=${TODO_SERVICE_STATIC_HOST}.${DOMAIN}'

  # TODO MEDIA SERVER
  todo-media:
    container_name: todo-media
    image: 'httpd:latest'
    restart: always
    volumes: ['./todo/media:/usr/local/apache2/htdocs']
    ports: ['80']
    logging: { driver: none }
    depends_on: [projec-proxy]
    environment:
      - 'VIRTUAL_HOST=${TODO_SERVICE_MEDIA_HOST}.${DOMAIN}'  

  # TODO WEB APP EVENT CONSUMER
  todo-web-event-consumer:
    image: 'todo-web-app:latest'
    container_name: todo-web-event-consumer
    build:
      context: ./todo
      args: { BUILD_ENV: $ENV }
    restart: always
    command: > 
      bash -c "/usr/src/app/wait-for-it project-redis:6379 && 
      /usr/src/app/start-eventconsumer"
    volumes: &todo-web-app-volumes              
      - './todo:/usr/src/app'
      - './libs:/usr/src/libs'
    environment: &todo-web-app-environment
      DJANGO_USE_DEBUG: 1
      MEDIA_HOST: "${TODO_SERVICE_MEDIA_HOST}.${DOMAIN}"       
      PYTHONUNBUFFERED: 1      
      REDIS_HOST: project-redis
      REDIS_PORT: 6379
      SECRET_KEY: $SECRET_KEY            
      STATIC_HOST: "${TODO_SERVICE_STATIC_HOST}.${DOMAIN}"                  
    depends_on: [projec-proxy, project-redis]
      
  # TODO WEB APP
  todo-web-app:
    container_name: todo-web-app
    image: 'todo-web-app:latest'
    restart: always
    command: /usr/src/app/start
    volumes: *todo-web-app-volumes
    ports: ['$TODO_SERVICE_PORT:8000']
    environment:      
      <<: *todo-web-app-environment
      SITE_HOST: "${TODO_SERVICE_HOST}.${DOMAIN}"
      SELENIUM_URL: http://project-selenium:4444
      TESTER_APP_URL: http://todo-app:8000
      VIRTUAL_HOST: "${TODO_SERVICE_HOST}.${DOMAIN}"
      VIRTUAL_PORT: 8000
    depends_on: [projec-proxy, project-selenium, todo-web-event-consumer]

  # TODO API APP EVENT CONSUMER
  todo-api-event-consumer:
    image: todo-api-app:latest
    container_name: todo-api-event-consumer
    build:
      context: ./todoapi
      args: { BUILD_ENV: $ENV }
    restart: always
    command: > 
      bash -c "/usr/src/app/wait-for-it project-redis:6379 && 
      /usr/src/app/start-eventconsumer"
    volumes: &todo-api-app-volumes
      - './todoapi:/usr/src/app'
      - './libs:/usr/src/libs'
    environment: &todo-api-app-environment
      DATABASE_URL: "sqlite:////usr/src/app/db.sqlite"
      FLASK_APP: app
      FLASK_ENV: $ENV      
      SECRET_KEY: $SECRET_KEY            
      REDIS_HOST: project-redis
      REDIS_PORT: 6379
      VIRTUAL_HOST: "${TODO_API_SERVICE_HOST}.${DOMAIN}"
      VIRTUAL_PORT: "${TODO_API_SERVICE_HOST}"
    depends_on: [projec-proxy, project-redis]

  # TODO API APP
  todo-api-app:
    container_name: todo-api-app
    restart: always    
    image: todo-api-app:latest    
    command: /usr/src/app/start
    ports: ['$TODO_API_SERVICE_PORT:8000']  
    depends_on: [projec-proxy, todo-api-event-consumer]
    volumes: *todo-api-app-volumes
    environment: *todo-api-app-environment    