version: '3'
services:    
  # REDIS
  project-redis-debugger:
    image: redis:latest
    container_name: project-redis-debugger
    networks: [todo-debugger]
    restart: always    
    ports: ["${REDIS_SERVICE_PORT}:6379"]

  # REDIS COMMANDER
  project-redis-commander-debugger:
    container_name: project-redis-commander-debugger
    depends_on: [project-redis-debugger]
    hostname: redis-commander
    image: rediscommander/redis-commander:latest
    logging: { driver: none }
    networks: [todo-debugger]
    ports: ["8081:8081"]
    restart: always
    environment:
      REDIS_HOSTS: local:project-redis-debugger:6379

  # TODO WEB APP EVENT CONSUMER
  todo-web-event-consumer-debugger:    
    image: 'todo-web-app:latest'    
    container_name: todo-web-event-consumer-debugger
    networks: [todo-debugger]
    restart: always
    working_dir: /usr/src/app/todo
    command: > 
      bash -c "/usr/src/app/todo/wait-for-it project-redis-debugger:6379 && /usr/src/app/todo/start-eventconsumer"
    volumes: 
      - './libs:/usr/src/libs'
      - './:/usr/src/app'
    environment: &todo-app-environment
      DJANGO_USE_DEBUG: 1
      MEDIA_HOST: "${TODO_SERVICE_MEDIA_HOST}.${DOMAIN}"       
      PYTHONUNBUFFERED: 1      
      REDIS_HOST: project-redis-debugger
      REDIS_PORT: 6379
      SECRET_KEY: $SECRET_KEY            
      STATIC_HOST: "${TODO_SERVICE_STATIC_HOST}.${DOMAIN}"                

  # TODO WEB APP
  todo-web-app-debugger:    
    volumes: ['./libs:/usr/src/libs', '.:/usr/src/app'] 
    restart: always
    ports: ['$TODO_SERVICE_PORT:8000']    
    networks: [todo-debugger]
    image: 'todo-app:latest'
    environment: *todo-app-environment
    depends_on: [todo-web-event-consumer-debugger]
    container_name: todo-web-app-debugger
    working_dir: /usr/src/app/todo
    command: /usr/src/app/todo/start

  # TODO API APP EVENT CONSUMER
  todo-api-event-consumer-debugger:
    image: todo-api-app:latest
    container_name: todo-api-event-consumer-debugger
    networks: [todo-debugger]
    restart: always
    working_dir: /usr/src/app/todoapi
    build:
      context: ./todoapi
      args: { BUILD_ENV: $ENV }
    command: > 
      bash -c "/usr/src/app/todoapi/wait-for-it project-redis-debugger:6379 && /usr/src/app/todoapi/start-eventconsumer"
    volumes: &todo-api-app-volumes
      - './libs:/usr/src/libs'
      - './:/usr/src/app'
    environment: &todo-api-app-environment
      DATABASE_URL: "sqlite:////usr/src/app/todoapi/db.sqlite"
      FLASK_APP: app
      FLASK_ENV: $ENV        
      SECRET_KEY: $SECRET_KEY            
      REDIS_HOST: project-redis-debugger
      REDIS_PORT: 6379
      VIRTUAL_HOST: "${TODO_API_SERVICE_HOST}.${DOMAIN}"
      VIRTUAL_PORT: "${TODO_API_SERVICE_HOST}"    

  # TODO API APP
  todo-api-app-debugger:
    container_name: todo-api-app-debugger
    restart: always    
    image: todo-api-app:latest        
    ports: ['$TODO_API_SERVICE_PORT:8000']  
    depends_on: [todo-api-event-consumer-debugger]
    working_dir: /usr/src/app/todoapi
    command: /usr/src/app/todoapi/start
    networks: [todo-debugger]
    volumes: *todo-api-app-volumes
    environment: *todo-api-app-environment

networks:      
  todo-debugger:      
      driver: bridge